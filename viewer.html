<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Viewer - YY's Blog</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/theme.css">
  <link rel="stylesheet" href="assets/css/md.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-file-alt"></i> File Viewer</h1>
    </div>
    
    <div class="breadcrumb" id="breadcrumb">
      <a href="index.html">首页</a>
    </div>
    
    <div class="content">
      <div id="contentArea">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i> 加载中...
        </div>
      </div>
    </div>
  </div>
  
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      renderer: 'svg',
      svg: {
        fontCache: 'global',
        mtextInheritFont: true
      }
    };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" id="MathJax-script"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const file = urlParams.get('file');
    
    if (!file) {
      document.getElementById('contentArea').innerHTML = `
        <div class="error">
          <i class="fas fa-exclamation-circle"></i>
          <p>未指定文件参数</p>
          <p>请使用 ?file=路径/文件名 的格式访问</p>
        </div>
      `;
    } else {
      // 检测文件类型
      const fileExtension = file.split('.').pop().toLowerCase();
      const contentArea = document.getElementById('contentArea');
      
      // 更新面包屑
      const pathParts = file.split('/');
      let breadcrumbHTML = '<a href="index.html">首页</a>';
      pathParts.forEach((part, index) => {
        if (index < pathParts.length - 1) {
          breadcrumbHTML += `<span>/</span><a href="viewer.html?file=${pathParts.slice(0, index + 1).join('/')}/index.md">${part}</a>`;
        } else {
          breadcrumbHTML += `<span>/</span><span>${part}</span>`;
        }
      });
      document.getElementById('breadcrumb').innerHTML = breadcrumbHTML;
      document.title = pathParts[pathParts.length - 1] + ' - YY\'s Blog';
      
      // 处理不同类型的文件
      if (['md', 'markdown'].includes(fileExtension)) {
        // 处理Markdown文件
        fetch(file)
          .then(response => {
            if (!response.ok) {
              throw new Error('文件不存在');
            }
            return response.text();
          })
          .then(markdown => {
            const html = marked.parse(markdown);
            // 检测是否是index.md文件
            const isReadme = file.includes('index.md');
            const className = isReadme ? 'markdown-body readme-file' : 'markdown-body regular-md-file';
            contentArea.innerHTML = `<div class="${className}">${html}</div>`;
            // 触发MathJax渲染
            if (window.MathJax) {
              if (MathJax.typeset) {
                MathJax.typeset();
              } else if (MathJax.typesetPromise) {
                MathJax.typesetPromise();
              }
            }
          })
          .catch(error => {
            contentArea.innerHTML = `
              <div class="error">
                <i class="fas fa-exclamation-triangle"></i>
                <p>加载失败: ${error.message}</p>
                <p>文件: ${file}</p>
              </div>
            `;
          });
      } else if (['jpg', 'jpeg', 'png', 'gif', 'svg', 'bmp', 'webp'].includes(fileExtension)) {
        // 处理图片文件
        contentArea.innerHTML = `
          <div class="image-viewer">
            <img src="${file}" alt="${pathParts[pathParts.length - 1]}">
            <p style="margin-top: 20px; color: #a0a0a0;">${pathParts[pathParts.length - 1]}</p>
          </div>
        `;
      } else if (['html', 'htm'].includes(fileExtension)) {
        // 处理HTML文件，使用iframe加载
        contentArea.innerHTML = `
          <div class="html-viewer">
            <iframe src="${file}" style="width: 100%; height: 80vh; border: none; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);"></iframe>
            <p style="margin-top: 15px; color: #a0a0a0;">${pathParts[pathParts.length - 1]}</p>
          </div>
        `;
      } else if (['txt', 'text', 'log', 'md', 'markdown', 'css', 'js', 'json', 'xml', 'yml', 'yaml', 'ini', 'conf', 'sh', 'py', 'java', 'c', 'cpp', 'h', 'hpp', 'go', 'rs', 'php', 'rb', 'swift', 'kt', 'ts', 'jsx', 'tsx'].includes(fileExtension)) {
        // 处理文本文件
        fetch(file)
          .then(response => {
            if (!response.ok) {
              throw new Error('文件不存在');
            }
            return response.text();
          })
          .then(text => {
            contentArea.innerHTML = `
              <div class="text-viewer">
                <pre>${escapeHtml(text)}</pre>
              </div>
            `;
          })
          .catch(error => {
            contentArea.innerHTML = `
              <div class="error">
                <i class="fas fa-exclamation-triangle"></i>
                <p>加载失败: ${error.message}</p>
                <p>文件: ${file}</p>
              </div>
            `;
          });
      } else {
        // 处理二进制文件
        contentArea.innerHTML = `
          <div class="binary-file">
            <div class="icon"><i class="fas fa-file-binary"></i></div>
            <h3>${pathParts[pathParts.length - 1]}</h3>
            <p style="margin: 20px 0; color: #a0a0a0;">这是一个二进制文件</p>
            <a href="${file}" class="btn">下载</a>
          </div>
        `;
      }
    }
    
    // 转义HTML特殊字符
    function escapeHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html>