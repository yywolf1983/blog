# SGF FF4 规范说明

## 1. 概述

SGF（Smart Game Format）是一种用于记录棋类游戏（如围棋、象棋等）的标准格式。FF4 是 SGF 的第四个版本，提供了更丰富的功能和更严格的规范。

## 2. 核心属性

### 2.1 根属性（Root Properties）

#### FF - 文件格式版本
- **属性值**：数字（范围：1-4）
- **默认值**：1
- **功能**：定义使用的文件格式版本。FF[4] 表示使用 SGF 4 标准。
- **示例**：`FF[4]`

#### CA - 字符集
- **属性值**：简单文本（simpletext）
- **默认值**：`ISO-8859-1`（又名 `Latin1`）
- **功能**：指定 SimpleText 和 Text 类型使用的字符集。
- **规范**：仅允许使用 RFC 1345（或其更新版本）中指定的字符集名称（或其别名）。
- **示例**：`CA[UTF-8]`

#### GM - 游戏类型
- **属性值**：数字（范围：1-16）
- **默认值**：1
- **功能**：定义当前游戏树中存储的游戏类型。
- **围棋对应值**：1
- **示例**：`GM[1]`

#### SZ - 棋盘大小
- **属性值**：数字 | 数字:数字
- **默认值**：游戏特定（围棋：19）
- **功能**：定义棋盘大小。单个值表示正方形棋盘，两个值表示矩形棋盘。
- **示例**：`SZ[19]`（19x19 围棋棋盘）

### 2.2 布局属性（Setup Properties）

#### AB - 黑棋
- **属性值**：棋子列表
- **功能**：在棋盘上添加黑棋。可用于设置让子或问题局面。
- **示例**：`AB[dp][pd]`（在 d4 和 p4 位置添加黑棋）

#### AW - 白棋
- **属性值**：棋子列表
- **功能**：在棋盘上添加白棋。可用于设置让子或问题局面。
- **示例**：`AW[dd][pp]`（在 d4 和 p4 位置添加白棋）

#### PL - 行棋方
- **属性值**：颜色
- **功能**：指定当前行棋方。用于设置局面时指定谁下。
- **示例**：`PL[B]`（黑方行棋）

### 2.3 行棋属性（Move Properties）

#### B - 黑棋行棋
- **属性值**：落子
- **功能**：执行黑棋落子。
- **示例**：`B[dd]`（黑棋下在 d4 位置）

#### W - 白棋行棋
- **属性值**：落子
- **功能**：执行白棋落子。
- **示例**：`W[pp]`（白棋下在 p4 位置）

## 3. 座子表示方法

### 3.1 单个座子

- **格式**：`AB[坐标]` 或 `AW[坐标]`
- **示例**：`AB[dp]`（在 d4 位置添加黑棋）

### 3.2 多个座子

- **格式**：`AB[坐标1][坐标2]...` 或 `AW[坐标1][坐标2]...`
- **示例**：`AB[dp][pd]`（在 d4 和 p4 位置添加黑棋）

### 3.3 压缩格式

SGF 支持使用压缩格式表示连续的座子：

- **格式**：`AB[起始坐标:结束坐标]`
- **示例**：`AB[aa:cc]`（在 a1 到 c3 区域添加黑棋）

## 4. 坐标系统

SGF 使用字母坐标系统：

- **横向**：a, b, c, ..., s（对应 1-19 列）
- **纵向**：a, b, c, ..., s（对应 1-19 行）
- **示例**：`dd` 表示第 4 列第 4 行（D4 位置）

### 注意事项
- 坐标大小写不敏感，`DD` 和 `dd` 表示同一个位置
- 棋盘大小为 19x19 时，坐标范围为 a-s

## 5. 示例 SGF 文件

### 5.1 基本示例

```sgf
(;FF[4]GM[1]SZ[19]AB[dp][pd]AW[dd][pp]C[测试座子功能])
```

### 5.2 完整示例

```sgf
(;FF[4]GM[1]SZ[19]CA[UTF-8]PB[黑方]PW[白方]RE[B+3.5]DT[2024-01-01]
AB[dp][pd]AW[dd][pp]
;B[ee];W[ff];B[gg];W[hh])
```

## 6. 应用实现要点

### 6.1 解析注意事项

1. **字符集处理**：应支持多种字符集，特别是 UTF-8，以正确显示中文等非英文注释。

2. **坐标解析**：
   - 支持大小写字母
   - 验证坐标范围
   - 正确处理压缩格式的座子表示

3. **属性处理**：
   - 正确解析 AB 和 AW 属性的多个值
   - 支持压缩格式的顶点列表

### 6.2 常见错误

1. **坐标越界**：应验证坐标是否在棋盘范围内。
2. **字符集错误**：未正确处理 UTF-8 编码的文件。
3. **压缩格式解析错误**：未正确解析 `AB[aa:cc]` 这样的压缩格式。
4. **属性值重复**：同一节点内不应有重复的 AB 或 AW 属性值。

## 7. 总结

SGF FF4 规范提供了一套完整的标准，用于记录和交换棋类游戏数据。正确实现 SGF 解析对于围棋打谱应用至关重要，特别是处理座子、字符集和各种属性的能力。

## 8. 参考资料

- [SGF 规范官方文档](https://www.red-bean.com/sgf/)
- [RFC 1345 - Character Set Information](https://tools.ietf.org/html/rfc1345)