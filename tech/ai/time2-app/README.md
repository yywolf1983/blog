# Android时间显示应用

## 项目概述

这是一个Android端的全屏时间显示应用，具有以下核心功能：
- 全屏显示当前时间，使用七段数码管模拟效果，采用金黄色辉光管风格
- 显示当前日期
- 显示当前时间的四柱（中国传统天干地支纪年、月、日、时）
- 在屏幕底部显示九宫格奇门派盘，根据吉凶等级显示不同颜色
- 屏幕常亮
- 支持横竖屏切换
- 开机自动启动

## 技术栈

- **开发语言**：Java
- **构建工具**：Android SDK命令行工具（aapt2, d8, apksigner, zipalign）
- **构建脚本**：bash脚本（build.sh）
- **最低SDK版本**：21（Android 5.0）
- **目标SDK版本**：33（Android 13）

## 项目结构

```
/Users/yy/pro-test/time2/
├── app/
│   ├── src/
│   │   ├── main/
│   │   │   ├── java/com/example/timedisplay/
│   │   │   │   ├── MainActivity.java         # 主活动类
│   │   │   │   ├── SevenSegmentDisplay.java   # 七段数码管自定义视图
│   │   │   │   ├── ColonDisplay.java          # 冒号自定义视图
│   │   │   │   ├── NinePalacePanel.java       # 九宫格奇门派盘视图
│   │   │   │   ├── TimeHandler.java           # 时间更新处理器
│   │   │   │   ├── TimeRunnable.java          # 时间更新线程
│   │   │   │   ├── TouchListener.java         # 触摸监听器
│   │   │   │   └── BootReceiver.java          # 开机启动广播接收器
│   │   │   ├── res/
│   │   │   │   ├── layout/
│   │   │   │   │   └── activity_main.xml      # 竖屏布局
│   │   │   │   ├── layout-land/
│   │   │   │   │   └── activity_main.xml      # 横屏布局
│   │   │   │   ├── values/
│   │   │   │   │   ├── colors.xml             # 颜色定义
│   │   │   │   │   ├── strings.xml            # 字符串定义
│   │   │   │   │   └── themes.xml             # 主题定义
│   │   │   └── AndroidManifest.xml            # 应用配置文件
│   └── build.gradle                           # 应用模块构建配置
├── build.sh                                   # 构建脚本
├── build_output/                              # 构建输出目录
├── README.md                                  # 项目主文档
├── qimen.py                                   # 奇门遁甲排盘算法参考
├── shizhu.py                                  # 四柱计算参考
├── build.gradle                               # 项目级构建配置
└── settings.gradle                            # 项目设置
```

## 核心功能实现

### 1. 七段数码管时间显示

**实现类**：`SevenSegmentDisplay.java`

**功能**：
- 使用Canvas绘制自定义的七段数码管显示效果
- 支持设置显示的数字
- 支持设置亮度
- 具有金黄色辉光管风格的发光效果和隐约的七段管轮廓
- 自动调整大小以适应不同屏幕尺寸

**关键方法**：
- `onMeasure()`：计算视图大小
- `onDraw()`：绘制七段数码管
- `setDigit(int digit)`：设置显示的数字
- `setBrightness(float brightness)`：设置亮度

### 2. 冒号显示

**实现类**：`ColonDisplay.java`

**功能**：
- 使用Canvas绘制自定义的冒号显示效果
- 与七段数码管保持一致的金黄色辉光管风格
- 支持设置亮度
- 自动调整大小以适应不同屏幕尺寸

**关键方法**：
- `onMeasure()`：计算视图大小
- `onDraw()`：绘制冒号
- `setBrightness(float brightness)`：设置亮度

### 3. 时间更新与显示

**实现类**：`MainActivity.java`, `TimeHandler.java`, `TimeRunnable.java`

**功能**：
- 每秒更新一次时间
- 使用Handler和Thread实现后台时间更新
- 为时间变化添加平滑的七段管风格切换动画
- 显示当前日期
- 显示当前时间的四柱

**关键方法**：
- `updateDateTime()`：更新时间和日期显示
- `animateTimeChange()`：为时间变化添加动画效果
- `updateFourPillars()`：更新四柱显示
- `calculateYearPillar()`, `calculateMonthPillar()`, `calculateDayPillar()`, `calculateTimePillar()`：计算四柱

### 4. 九宫格奇门派盘

**实现类**：`NinePalacePanel.java`

**功能**：
- 在屏幕底部显示九宫格奇门派盘
- 基于完整传统奇门遁甲理论实现排盘算法
- 按照传统方位排布九宫格（乾西北、坎正北、艮东北、震正东、中中心、巽东南、坤西南、离正南、兑正西）
- 根据吉凶等级显示不同颜色：吉为浅绿色，凶为浅红色，平为天蓝色
- 显示九宫格的宫名、卦象符号、方位符号和对应的数据（星、门、神、天干、旺衰、吉凶）
- 支持亮度调整

**关键方法**：
- `onMeasure()`：确保九宫格是正方形
- `onDraw()`：绘制九宫格网格和数据
- `setBrightness(float brightness)`：设置亮度
- `calculateQiMenPanel(String yearPillar, String monthPillar, String dayPillar, String timePillar)`：根据四柱计算完整奇门派盘
- `isYangDun(String monthZhi)`：判断是否为阳遁
- `getJuShu(String monthZhi, boolean isYangDun)`：获取用局数
- `arrangeDiPanTianGan(int ju, boolean isYangDun)`：排地盘天干
- `arrangeNineStars(int ju, boolean isYangDun)`：排九星（天盘）
- `arrangeEightDoors(String timeZhi, boolean isYangDun)`：排八门（人盘）
- `arrangeEightGods(int zhiFuPalace, boolean isYangDun)`：排八神（神盘）
- `getXunShouInfo(String timeGan)`：获取旬首信息
- `calculateWangCui(String dayGan, int palaceIndex)`：计算旺衰
- `getGuaSymbol(int palaceIndex)`：获取每个宫位的卦象符号
- `getDirectionSymbol(int palaceIndex)`：获取每个宫位的方位符号
- `getLuckSymbol(int starIndex, int doorIndex)`：计算每个宫位的吉凶标识

### 5. 触摸唤醒功能

**实现类**：`TouchListener.java`

**功能**：
- 监听触摸事件
- 当屏幕关闭时，轻触屏幕可唤醒设备

### 6. 开机自动启动

**实现类**：`BootReceiver.java`

**功能**：
- 监听开机完成广播
- 当设备开机时，自动启动应用

## 布局设计

### 竖屏布局
- 时间显示：位于屏幕上方，使用七段数码管显示，金黄色辉光管效果
- 日期和四柱：位于时间下方，字体较小
- 九宫格：位于屏幕底部，根据吉凶等级显示不同颜色

### 横屏布局
- 时间显示：位于屏幕右侧，使用七段数码管显示，金黄色辉光管效果
- 日期和四柱：位于时间下方，字体较小
- 九宫格：位于屏幕左侧，根据吉凶等级显示不同颜色

## 颜色方案

- **背景颜色**：深蓝色（#0A0A14），保持沉稳风格
- **七段数码管颜色**：金黄色（#FFD700），辉光管效果，具有隐隐发光的视觉效果
- **冒号颜色**：金黄色（#FFD700），与七段数码管保持一致的辉光效果
- **九宫格颜色**：根据吉凶等级显示不同颜色
  - 吉：浅绿色（#90EE90）
  - 凶：浅红色（#FF8C8C）
  - 平：天蓝色（#87CEEB）
- **文字颜色**：浅蓝色（#ADD8E6），提高可读性
- **整体色调**：蓝黄为主，辉光管效果增强视觉冲击力

## 算法实现

### 1. 四柱计算算法

**算法实现**：
- **年柱计算**：以立春为年分界，使用60甲子循环计算
  - 基准年：1900年为庚子年（索引36）
  - 计算方法：`(36 + 年份差) % 60` 得到年柱索引
  - 注意：如果当前日期在立春前（2月4日前），则年份减1

- **月柱计算**：使用五虎遁诀计算月干，根据月份确定月支
  - 五虎遁诀：甲己之年丙作首，乙庚之岁戊为头，丙辛岁首寻庚起，丁壬壬寅顺水流，若问戊癸何处起，甲寅之上好追求
  - 月支分配：以节气为分界，简化处理为直接按月份分配

- **日柱计算**：以1900年1月1日为基准（甲午日，索引30），计算天数差后确定干支
  - 计算方法：`(30 + 天数差) % 60` 得到日柱索引
  - 注意：需要考虑闰年的影响

- **时柱计算**：使用日上起时法计算时干，根据时间确定时支
  - 日上起时法：甲己还加甲，乙庚丙作初，丙辛从戊起，丁壬庚子居，戊癸何方发，壬子是真途
  - 时支分配：子时（23:00-1:00）、丑时（1:00-3:00）... 亥时（21:00-23:00）
  - 特殊处理：45分后进入下一时辰

### 2. 奇门遁甲排盘算法

**算法实现**：
1. **阴阳遁判断**：
   - 阳遁：2-7月（立春到立秋之间）
   - 阴遁：其他月份（立秋到立春之间）
   - 或根据节气判断：冬至到芒种为阳遁，夏至到大雪为阴遁

2. **用局数计算**：
   - 传统月份对应用局表：
     | 月份 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 |
     |------|---|---|---|---|---|---|---|---|---|----|----|----|
     | 用局 | 1 | 8 | 1 | 3 | 4 | 6 | 9 | 2 | 9 | 7  | 6  | 4  |
   - 或根据节气确定用局数

3. **排地盘（天干基础盘）**：
   - 天干顺序：戊、己、庚、辛、壬、癸、丁、丙、乙
   - 阳遁：顺时针排列，从用局数减1的宫位开始
   - 阴遁：逆时针排列，从用局数减1的宫位开始

4. **排天盘（九星）**：
   - 九星顺序：天蓬、天芮、天冲、天辅、天英、天柱、天心、天禽、天任
   - 阳遁：顺时针排列，从用局数减1的宫位开始
   - 阴遁：逆时针排列，从用局数减1的宫位开始

5. **排人盘（八门）**：
   - 八门顺序：休、生、伤、杜、景、死、惊、开
   - 根据时支确定起始门
   - 阳遁：顺时针排列
   - 阴遁：逆时针排列
   - 中五宫借用生门

6. **排神盘（八神）**：
   - 八神顺序：值符、螣蛇、太阴、六合、白虎、玄武、九地、九天
   - 从值符星所在宫位开始
   - 阳遁：顺时针排列
   - 阴遁：逆时针排列

7. **确定值符值使**：
   - 基于旬首计算：甲子旬值符天蓬、甲戌旬值符天芮、甲申旬值符天冲、甲午旬值符天辅、甲辰旬值符天禽、甲寅旬值符天心
   - 值使为对应旬首的门

8. **计算旺衰**：
   - 根据日干五行与九宫五行的生克关系
   - 五行相生：金生水，水生木，木生火，火生土，土生金
   - 五行相克：金克木，木克土，土克水，水克火，火克金

9. **计算吉凶**：
   - 基于星门组合判断
   - 吉星吉门组合为吉，凶星凶门组合为凶，其他为平

**参考实现**：请参考 `qimen.py` 文件

## 构建与安装

### 构建APK

```bash
./build.sh
```

构建完成后，APK文件将生成在 `./build_output/app-aligned.apk`。

### 安装APK

```bash
./build.sh install
```

或

```bash
adb install ./build_output/app-aligned.apk
```

## 自启动设置

在安装应用后，需要在设备上手动授予自启动权限：

### 小米手机（MIUI 11.0.5及以上）：
- 设置 → 应用设置 → 应用管理 → Time Display → 权限管理 → 自启动权限 → 开启
- 设置 → 电池与性能 → 应用省电管理 → Time Display → 选择"无限制"

### 华为手机：
- 设置 → 应用 → 应用启动管理 → Time Display → 关闭自动管理 → 开启允许自启动

### OPPO手机：
- 设置 → 电池 → 应用耗电管理 → Time Display → 允许后台运行

### VIVO手机：
- 设置 → 电池与性能 → 后台高耗电 → Time Display → 开启

### 三星手机：
- 设置 → 应用程序 → 应用程序管理器 → Time Display → 电池 → 后台限制 → 选择无限制

## 故障排除

### 时间不自动刷新
- 检查`TimeHandler.java`和`TimeRunnable.java`是否正确实现
- 确保线程正常启动和运行

### 开机不自动启动
- 检查是否正确授予了自启动权限
- 检查`BootReceiver.java`是否正确实现
- 检查`AndroidManifest.xml`中的广播接收器配置

### 小屏幕显示异常
- 应用使用了响应式布局，应该能适应不同屏幕尺寸
- 如果显示异常，可能需要调整布局文件中的尺寸和权重设置

### 应用崩溃
- 检查日志中的错误信息
- 确保所有布局文件中的视图类型与代码中的类型转换一致
- 确保所有必要的权限都已在`AndroidManifest.xml`中声明

## MIUI 11.0.5 兼容性

### 兼容性考虑
- **主题兼容性**：使用了基础的Material主题，避免使用可能在MIUI上有冲突的Material Components主题
- **权限管理**：针对MIUI的严格权限管理，提供了详细的自启动权限设置步骤
- **后台限制**：考虑到MIUI的后台进程限制，优化了应用的后台运行方式
- **屏幕常亮**：使用系统标准的WAKE_LOCK权限，确保在MIUI上正常工作
- **横竖屏切换**：支持全屏传感器模式，适配MIUI的屏幕旋转设置

### 特殊注意事项
1. **自启动权限**：MIUI默认禁用应用自启动，必须手动开启
2. **省电模式**：在MIUI的省电模式下，应用可能会被限制后台活动
3. **应用锁**：如果启用了应用锁，首次启动时需要验证解锁
4. **权限弹窗**：MIUI可能会弹出权限请求弹窗，需要用户手动允许
5. **系统更新**：MIUI系统更新后，可能需要重新设置自启动权限

## 项目规范

### 核心原则
- **模块化**：项目结构清晰，功能单一
- **简洁性**：做一件事，并把它做好。避免过度设计
- **可组合性**：便于与其他工具通过标准接口组合使用
- **透明性**：设计清晰明了，便于检查和调试
- **健壮性**：程序应具备良好的错误处理和容错能力

### 代码风格
- **可读性优先**：代码应易于理解
- **一致性**：在整个项目中保持风格一致
- **简洁性**：避免不必要的复杂性
- **注释**：为复杂逻辑添加清晰注释
- **错误处理**：适当处理错误，提供有意义的错误信息

### 文档规范
- **文档优先**：每个项目必须包含 `README.md` 文件，作为项目的主文档
- **对话内容提取**：每次对话产生的通用描述和重要信息应提取整理，添加到项目相应的MD文件中，确保这些文件随时可以重建项目

**详细规范**：已整合到本README.md文件中

## 未来扩展

- 添加更多显示主题
- 实现自定义设置界面
- 添加更多时间显示格式
- 实现天气显示功能（可选）
- 添加电池电量显示
- 优化辉光管效果，增加更多发光动画
- 支持更多传统玄学功能
- 添加多语言支持
- 实现应用内设置面板

## 结论

这是一个功能完整的Android时间显示应用，具有现代的七段数码管显示效果、中国传统四柱显示、奇门遁甲九宫格排盘等功能。应用使用了响应式布局，能适应不同屏幕尺寸，适合作为桌面摆件使用。

通过金黄色辉光管效果和根据吉凶等级显示不同颜色的九宫格，应用在视觉上具有强烈的冲击力，同时保持了传统玄学的文化内涵。

应用已经过优化，能够在MIUI 11.0.5等系统上正常运行，提供了详细的自启动设置步骤，确保用户能够顺利使用所有功能。