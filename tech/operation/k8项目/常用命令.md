# 常用命令

cat <<EOF > /etc/docker/daemon.json
{
   "insecure-registries": ["47.108.235.230:8090"],
   "exec-opts": ["native.cgroupdriver=systemd"]
}
EOF

kubectl config view

kubectl get nodes

docker load -i  load*.tar

证书信息
/etc/kubernetes/pki

查看资源api
kubectl api-resources

标签和标签选择器
监控检查 资源分配

扩容
kubectl scale --replicas=5 deploy nginx-test
#自动伸缩
kubectl autoscale deployment.v1.apps/nginx-deployment --min=10 --max=15 --cpu-percent=80

内部域名访问
<服务名>.<命名空间>.svc.cluster.local
curl nginx-service-nodeport.default.svc.cluster.local
        pods    ns    service   domain.string
      <service-name>.<namespace-name>.svc.cluster.local

进入某个pods
kubectl exec ngx-dep3-7998cdf69b-xn7rb  -it bash
kubectl exec -it redis -- redis-cli

kubectl create service clusterip ngx-dep --tcp=80:80  #本地端口 后端端口

### 节点维护
kubectl cordon m2     禁止调度
kubectl uncordon m2   恢复调度

### 驱逐节点
kubectl drain m2 --delete-local-data --ignore-daemonsets --force 

扩容
kubectl scale --replicas=5 deploy nginx-test


kubectl apply -f nginx-deployment.yaml

kubectl delete pvc --all

kubectl create
kubectl edit      编辑 
kubectl describe  查看详细
kubectl delete
kubectl get all  
kubectl logs      排错看日志
kubectl logs svc/redis2-master

   no nodes
   po pods
   pvc pv
   svc services
   deploy deployments  查看副本状态
   ing ingress
   cm configmap
   sts statefulset
   ns   #命名空间 Namespaces
   secrets
   cronjobs
   
   -A -o wide
   --show-labels
   -n kube-system
   -n kubernetes-dashboard
   -n ingress-nginx
   -o json

kubectl logs -f mysql-master-0 --all-containers

# master 可调度
kubectl taint nodes --all node-role.kubernetes.io/master-

添加标签
kubectl label nodes m3 mysql=slave
删除标签
kubectl label node m3 mysql-

kubectl delete replicaset -l  name=nginx-test

# 输出状态
kubectl get deployment nginx-deployment -o yaml

kubectl get all

kubectl create deploy ngx-dep --image=47.108.235.230:8090/base/nginx:latest

kubectl create secret tls example-secret --key private.key --cert www.pem


sudo minikube service wordpress --url

kubectl delete -k ./  清理

kubectl create secret docker-registry myregistry \
       --docker-server=47.108.235.230:8090 \
       --docker-username=admin \
       --docker-password=Harbor1234567890 \
       --docker-email=admin@admin.com


# 更新回滚镜像 
kubectl set image deployment/nginx-deployment nginx=nginx:1.16.1 --record

# 回滚到上一个状态
kubectl rollout undo deployment.v1.apps/nginx-deployment

# 回滚到指定版本
kubectl -n test rollout undo deployment tnginx --to-revision=6

# 查看运行状态
kubectl rollout status deployment nginx-deployment
#查看历史
kubectl rollout history deployment nginx-deployment
#详细历史
kubectl rollout history deployment nginx-deployment --revision=2
# 暂停
kubectl rollout pause deployment.v1.apps/nginx-deployment

# 修改参数
# 热更新
kubectl patch deployment nginx-test --patch '{"spec": {"template": {"metadata": {"annotations": {"version/config": "20211129" }}}}}'

# configmaps
kubectl create configmap nginx-config --from-file=./nginx.conf  --from-file=./default.conf



# 转发端口
sudo kubectl port-forward --address 0.0.0.0 --namespace=ingress-nginx service/ingress-nginx-controller 80:80

# 外部端口
kubectl get svc -n kubernetes-dashboard

kubectl patch svc kubernetes-dashboard  -p '"spec": {"type": "NodePort","ports": [{"port": 443,"nodePort": 31000}]}' -n kubernetes-dashboard


kubectl get svc -n kubernetes-dashboard -o json


#剔除节点
kubectl cordon k8s-node3
kubectl uncordon k8s-node3

#驱逐pod
kubectl drain k8s-node3

#资源信息查看
https://github.com/kubernetes-sigs/metrics-server
--kubelet-insecure-tls to Metrics Server

kubectl get apiservice
kubectl top node

## 网络相关
 kubectl cluster-info
 kubectl get endpoints

 kubectl exec -i -t tnginx
 kubectl get svc tnginx -s
 kubectl describe svc tnginx -n test

扁平网络
 kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml


nslookup  mysql.test.svc.cluster.local


查看dns

tail -f /dev/null

helm repo add coredns https://coredns.github.io/helm
helm --namespace=kube-system install coredns coredns/coredns



安装coredns
https://github.com/coredns/deployment.git
./deploy.sh -i 10.100.0.10 | kubectl apply -f -

kubectl -n kube-system edit configmap coredns-coredns

kubectl get pods --namespace=kube-system -l k8s-app=kube-dns
kubectl get ep kube-dns --namespace=kube-system

kubectl -n kube-system get cm coredns -oyaml

kubectl logs -f coredns-55b9c7d86b-gmkkn  -n kube-system

cat /etc/resolv.conf

apt install dnsutils

tnginx.test.svc.cluster.local:8848

helm repo add nginx-stable https://helm.nginx.com/stable
helm repo update
helm install nginx-ingress  nginx-stable/nginx-ingress


## 安装 flannel
kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml


DaemonSets 每台机器一个

mysql -uroot -p -h 10.100.56.79 --ssl-mode=disabled

## 更换ip后重新认证

kubectl -n kubernetes-dashboard get secret
kubectl describe secrets -n kubernetes-dashboard kubernetes-dashboard-token-xxxxx  | grep token | awk 'NR==3{print $2}'


kubectl create clusterrolebinding serviceaccount-cluster-admin --clusterrole=cluster-admin --group=system:serviceaccount 
kubectl delete clusterrolebinding serviceaccount-cluster-admin
kubectl create clusterrolebinding serviceaccount-cluster-admin --clusterrole=cluster-admin --user=system:serviceaccount:kubernetes-dashboard:kubernetes-dashboard