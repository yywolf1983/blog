# 安全运维

## 安全原则

- 职权分离
- 服务器分离
- 账号分离
- 文件分离
- 代码分离
- cookie分离
- 子域分离

## 应急响应

- 漏洞的黄金应急时间：24h、12h、6h、1h
- 热点隔离
- "军事演习"（数据库、存储等的备份等都要实际恢复模拟演练，负载均衡高可用也是如此）

## 系统安全

- kdump是在系统崩溃、死锁或者死机的时候用来转储内存运行参数的一个工具和服务
- hydra 密码破解工具

## 安全检查

### 登录检查
```bash
more /var/log/secure | grep Accepted
last -f /var/log/wtmp
```

### 漏洞检查
- 心脏滴血影响版本：OpenSSL 1.0.2-beta、OpenSSL 1.0.1 - OpenSSL 1.0.1f

### 双网卡 Bonding

### 历史命令
```bash
sed -i '/HIST/d' /etc/bashrc
echo "HISTFILESIZE=2000" >> /etc/bashrc && echo "HISTSIZE=2000" >> /etc/bashrc && echo 'HISTTIMEFORMAT="%Y%m%d %T "'>> /etc/bashrc && export HISTTIMEFORMAT
```

### Shellshock 漏洞检查
```bash
env x='() { :;}; echo vulnerable'  bash -c "echo this is a test"
```

### 系统优化

#### 关闭GUI
```bash
/etc/inittab
id:3:initdefault:（5为GUI，3为命令行）
```

#### 密码策略
```bash
/etc/login.defs
```

#### 关闭root用户登陆，使用sudo
```bash
useradd test
vi /etc/sudoers
test ALL=(ALL) ALL
```

#### 调整打开文件数
```bash
ulimit -n
cat /etc/security/limits.conf

# 直接把ulimit -SHn 65535命令加入到开机自启动文件里面/etc/rc.local，每次开机启动的时候生效。
# -S use the 'soft' resource limit
# -H use the 'hard' resource limit
# -n the maximum number of open file descriptors （最大文件描述符）

vi /etc/security/limits.conf
# centos 7 注意一下文件
# /etc/security/limits.d/20-nproc.conf

# 添加如下的行
* soft noproc 11000
* hard noproc 11000
* soft nofile 4100
* hard nofile 4100
# 说明：* 代表针对所有用户
#     noproc 是代表最大进程数
# nofile 是代表最大文件打开数
```

#### 禁止usb
```bash
install usb-storage /bin/true
```

#### 网络优化
```bash
# 修改/etc/sysctl.conf文件，在文件中添加如下行：
net.ipv4.ip_conntrack_max = 10240              #tcp最大连接数
net.ipv4.ip_local_port_range = 1024 65536      #允许系统打开的端口范围
net.core.rmem_max=16777216
net.core.wmem_max=16777216
net.ipv4.tcp_rmem=4096 87380 16777216
net.ipv4.tcp_wmem=4096 65536 16777216
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_timestamps = 0
net.ipv4.tcp_window_scaling = 0
net.ipv4.tcp_sack = 0
net.core.netdev_max_backlog = 30000
net.ipv4.tcp_no_metrics_save=1
net.core.somaxconn = 262144
net.ipv4.tcp_syncookies = 0 表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击，默认为0，表示关闭；
net.ipv4.tcp_tw_reuse = 1 表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；
net.ipv4.tcp_tw_recycle = 1 表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。
net.ipv4.tcp_fin_timeout 修改系統默认的 TIMEOUT 时间
net.ipv4.tcp_max_orphans = 262144
net.ipv4.tcp_max_syn_backlog = 262144   #设置SYN连接数
net.ipv4.tcp_synack_retries = 2  #减少syn重试次数 默认5次 1s + 2s + 4s+ 8s+ 16s + 32s = 2^6 -1 = 63s
net.ipv4.tcp_syn_retries = 2

net.ipv4.tcp_abort_on_overflow    处理不过来干脆就直接拒绝连接了。

sysctl -p
```

#### 文件完整性检查
```bash
find /usr/local/sbin /usr/local/bin /usr/sbin /usr/bin /sbin /bin -type f |xargs md5sum >md5hostname.txt
```

## 数据库安全

### Oracle 密码过期时间修改
```sql
SELECT * FROM dba_profiles s WHERE s.profile='DEFAULT' AND resource_name='PASSWORD_LIFE_TIME';
ALTER PROFILE DEFAULT LIMIT PASSWORD_LIFE_TIME UNLIMITED;
```

### Oracle 连接数修改
```sql
sqlplus /nolog
conn /as sysdba
show parameter processes
alter system set processes=650 scope=spfile
shutdown immediate;
startup
```

### 修改数据库密码过期时间
```sql
SELECT * FROM dba_profiles WHERE profile='DEFAULT' AND resource_name='PASSWORD_LIFE_TIME'
ALTER PROFILE DEFAULT LIMIT PASSWORD_LIFE_TIME UNLIMITED  
```

## Ubuntu 相关
```bash
sudo apt-get install build-essential
sudo apt-get install kernel-package
sudo make-kpkg --initrd kernel_image kernel-headers
sudo dpkg -i linux-image-
```

## 安全选项

### 1. 禁用不使用的用户
```bash
cp /etc/passwd{,.bak} # 修改之前先备份
vi /etc/passwd # 编辑用户，在前面加上#注释掉此行

# 组
cp /etc/group{,.bak}
vi /etc/group
```

### 2. 关闭不使用的服务
```bash
# 服务检测
chkconfig --list |grep '3:on'

# 关闭服务
service iptables stop
chkconfig iptables --level 2345 off
```

### 3. 禁用ipv6
```bash
# /etc/modprobe.d/ipv6off.conf，内容如下
alias net-pf-10 off
options ipv6 disable=1

# 禁用基于IPv6网络，使之不会被触发启动：
# vi /etc/sysconfig/network
NETWORKING_IPV6=no

# 禁用网卡IPv6设置，使之仅在IPv4模式下运行：
# vi /etc/sysconfig/network-scripts/ifcfg-eth0
IPV6INIT=no
IPV6_AUTOCONF=no

# 关闭ip6tables：
# chkconfig ip6tables off

# 重启系统，验证是否生效：
# lsmod | grep ipv6
# ifconfig | grep -i inet6
# 如果没有任何输出就说明IPv6模块已被禁用，否则被启用。
```

### 4. 设置防火墙规则

### 5. 修改ssh端口
```bash
# 设置登录超时
export TMOUT=300
readonly TMOUT

# 禁止root直接远程登录
# vi /etc/ssh/sshd_config
####by Ian#2016-08-07##
Port 52113  #ssh连接默认的端口。因为之前大家都知道是22，所以得修改
PermitRootLogin no   #root这个用户大家都知道，所以得禁止它远程登录
PermitEmptyPasswords no #禁止空密码登录
UseDNS  no    #不使用DNS
GSSAPIAuthentication no
####by Ian#2016-08-07##
```

### 6. 限制登录失败次数并锁定
```bash
# 在/etc/pam.d/login后添加
auth required pam_tally2.so deny=6 unlock_time=180 even_deny_root root_unlock_time=180
```

### 7. 登录IP限制

### 8. 增强特殊文件权限
```bash
chattr +i /etc/passwd
chattr +i /etc/shadow
chattr +i /etc/group
chattr +i /etc/gshadow
chattr +i /etc/services #给系统服务端口列表文件加锁，防止未经许可的删除或添加服务
chattr +i /etc/pam.d/su
chattr +i /etc/ssh/sshd_config

# 显示文件的属性
lsattr /etc/passwd /etc/shadow /etc/services /etc/ssh/sshd_config

# 将chattr 转移
mv `which chattr` /usr/bin/iancmd

# 一般情况下，一个规范的系统提供的服务都比较少，因此，系统中默认的虚拟用户都是可以删掉的。如：bin、adm、lp、halt、mail、uucp、operator、games、gopher、ftp、dbus、vcsa、abrt、ntp、saslauth、postfix、tcpdump等。这些用户本身也是无法登录的，所以此项优化不是必须的。
```

### 9. 定期做日志安全检查
- `/var/log/message` – 记录系统日志或当前活动日志。
- `/var/log/auth.log` – 身份认证日志。
- `/var/log/cron` – Crond 日志 (cron 任务).
- `/var/log/maillog` – 邮件服务器日志。
- `/var/log/secure` – 认证日志。
- `/var/log/wtmp` 历史登录、注销、启动、停机日志和，lastb命令可以查看登录失败的用户
- `/var/run/utmp` 当前登录的用户信息日志，w、who命令的信息便来源与此
- `/var/log/yum.log` Yum 日志。
- `/var/log/lastlog` 记录系统中所有用户最后一次登录时间的日志，使用lastlog命令查看
- `/var/log/btmp`   记录所有登录失败信息，使用lastb命令查看

## 清理登录信息
```bash
echo > /var/log/btmp 
lastb
echo > /var/log/wtmp  
last
echo > /var/log/lastlog
lastlog
echo >   /var/log/utmp 
w;who;users

cat /dev/null >  /var/log/secure
cat /dev/null >  /var/log/message

history -c
rm ~/.*history

fuser -k /dev/pts/*
```

## 服务管理
```bash
systemctl disable tuned
systemctl stop tuned
```