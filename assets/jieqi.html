<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="UTF-8">
<head>
<title>节气显示</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="animated_favicon.gif" type="image/gif">
  <base target="_blank" />
  <script type="text/javascript" src="data-years.js"></script>
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/jieqi.css">
</head>
<body>
  <div class="container">
    <h1 class="title">二十四节气</h1>
    <div id="jieqi" class="jieqi-grid"></div>
  </div>
</body>
<script type="text/javascript">
    var z_dic = { 1:"一", 2:"丁", 3:"上", 4:"止", 5:"正" };
    var all_str = ""
    var ztime = true;

    var today = to_day()+" 08:00:00"
    var year = today.split('-')[0]
    var jieqi_list = jieqi_d(year);
    var jieqi_time = new Date(jieqi_list["正  立春  东风解  蛰虫始  鱼陟冰"]).getTime()
    var now_time = new Date(today).getTime()

    console.log(jieqi_time,now_time)

    if (jieqi_time > now_time) 
    {
      year = year - 1
    }
    console.log(year)
    var str = jieqi_d(year);
    
    var 大寒日期 = str["腊  大寒  鸡乳卵  征鸟厉  泽腹坚"];
    var 大寒时间 = new Date(大寒日期).getTime();
    var 下一年立春 = jieqi_d(year + 1)["正  立春  东风解  蛰虫始  鱼陟冰"];
    var 下一年立春时间 = new Date(下一年立春).getTime();
    
    if (now_time > 大寒时间 && now_time >= 下一年立春时间) {
      year = year + 1;
      console.log('已过大寒和立春，显示下一年节气:', year);
      str = jieqi_d(year);
    } else if (now_time > 大寒时间) {
      console.log('已过大寒但未到立春，保持显示当前年份节气');
    }
    
    function getCurrentJieqi() {
      var currentDate = new Date(today);
      var currentTime = currentDate.getTime();
      
      if (currentTime > 大寒时间 && currentTime < 下一年立春时间) {
        return "大寒";
      }
      
      for (var i = 0; i < 24; i++) {
        var jieqiName = Object.keys(str)[i];
        var jieqiDate = Object.values(str)[i];
        var jieqiTime = new Date(jieqiDate).getTime();
        
        var nextJieqiTime;
        if (i === 23) {
          nextJieqiTime = 下一年立春时间;
        } else {
          var nextJieqiDate = Object.values(str)[i + 1];
          nextJieqiTime = new Date(nextJieqiDate).getTime();
        }
        
        if (currentTime >= jieqiTime && currentTime < nextJieqiTime) {
          return jieqiName.split('  ')[1];
        }
      }
      
      return "未知";
    }
    
    var currentJieqi = getCurrentJieqi();
    console.log('当前日期对应的节气:', currentJieqi);

    for(var j=0;j<=23;j++){
       var run_nums = time_day(Object.values(str)[j])
       run_num = run_nums/1000/60/60/24
       
       var z_dics = " 〇 〇 〇 ";
       
       if (run_num >= 15)
       {
          z_dics = " 正 正 正 "
       }
       else if (run_num >= 0)
       {
          u = parseInt(run_num/5)
          u1 = Math.floor(run_num%5)
          u1 = Math.max(0, Math.min(4, u1));
          var z_dic_values = ['', '一', '丁', '上', '止', '正'];
          u2 = z_dic_values[u1 + 1] || "正";
          if (u == 0)
             z_dics=" "+u2+" 〇 〇 "

          if (u == 1)
             z_dics=" 正 "+u2+" 〇 "

          if (u == 2)
             z_dics=" 正 正 "+u2+" "
       }
       
       var nextIndex = (j + 1) % 24;
       var nextJieqiDate;
       var nextJieqiName;
       if (nextIndex === 0) {
         var nextYearStr = jieqi_d(year + 1);
         nextJieqiDate = Object.values(nextYearStr)[0];
         nextJieqiName = Object.keys(nextYearStr)[0].split('  ')[1];
       } else {
         nextJieqiDate = Object.values(str)[nextIndex];
         nextJieqiName = Object.keys(str)[nextIndex].split('  ')[1];
       }
       
       var jieqiName = Object.keys(str)[j].split('  ')[1];
       var isActive = (jieqiName === currentJieqi);
       
       all_str += '<div class="jieqi-card" style="animation-delay: ' + (j * 0.05) + 's;">';
       all_str += '<div class="jieqi-name">' + jieqiName + '</div>';
       all_str += '<div class="jieqi-status">';
       
       if (run_num >= 15) {
         all_str += '<div class="status-item status-active">正</div>';
         all_str += '<div class="status-item status-active">正</div>';
         all_str += '<div class="status-item status-active">正</div>';
       } else if (run_num >= 0) {
         for (var k = 0; k < 3; k++) {
           if (k < u) {
             all_str += '<div class="status-item status-active">正</div>';
           } else if (k === u) {
             all_str += '<div class="status-item status-active">' + u2 + '</div>';
           } else {
             all_str += '<div class="status-item status-inactive">〇</div>';
           }
         }
       } else {
         all_str += '<div class="status-item status-inactive">〇</div>';
         all_str += '<div class="status-item status-inactive">〇</div>';
         all_str += '<div class="status-item status-inactive">〇</div>';
       }
       
       all_str += '</div>';
       all_str += '<div class="jieqi-date">' + nextJieqiDate + '</div>';
       all_str += '<div class="jieqi-next">下个节气：<span>' + nextJieqiName + '</span></div>';
       all_str += '</div>';
    }
    
    document.getElementById("jieqi").innerHTML = all_str

    console.log("从",start_time,"到",end_time,"相距",to_times/1000/60/60/24,"天")
    console.log(parseInt(((to_times/1000/60/60/24)-run_num)/365),"年 零",((to_times/1000/60/60/24)-run_num)%365,"天")
</script>
</html>
